name: Render manifests

permissions:
  contents: write

on:
  push:
    paths:
      - management/**
      - management/environments/**
      - apps/**
      - apps/environments/**
      - .github/**

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install helm
        uses: azure/setup-helm@v4

      - name: Add helm repos from Chart.lock
        run: |
          set -euo pipefail

          for lock in $(find management/ apps/ -name Chart.lock); do
            echo "Processing $lock"
            awk '/repository:/ {print $2}' "$lock" | sort -u | while read -r repo; do
              name=$(echo "$repo" | sed 's|https\?://||; s|/|-|g')
              helm repo add "$name" "$repo" || true
            done
          done

          helm repo update

      - name: Cache workspace
        uses: actions/cache/save@v4
        with:
          path: .
          key: workspace-${{ github.sha }}

  render:
    needs: setup
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app:
          - media-stack
          - home-assistant

    steps:
      - name: Restore workspace
        uses: actions/cache/restore@v4
        with:
          path: .
          key: workspace-${{ github.sha }}

      - name: Build helm dependencies for ${{ matrix.app }}
        run: |
          helm dependency build apps/${{ matrix.app }}

      - name: Render ${{ matrix.app }}
        run: |
          mkdir -p apps/rendered/prod/${{ matrix.app }}
          helm template ${{ matrix.app }} apps/${{ matrix.app }} -n ${{ matrix.app }} \
            | tee apps/rendered/prod/${{ matrix.app }}/${{ matrix.app }}.yaml

      # Persist rendered output for the cleanup job
      - name: Cache rendered output
        uses: actions/cache/save@v4
        with:
          path: apps/rendered
          key: rendered-${{ github.sha }}-${{ matrix.app }}

  cleanup:
    needs: render
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore rendered output
        uses: actions/cache/restore@v4
        with:
          path: apps/rendered
          key: rendered-${{ github.sha }}-

      - name: Commit rendered output
        run: |
          git config user.name "gitops-bot"
          git config user.email "gitops-bot@example.com"
          git add apps/rendered
          git commit -m "chore(render): update rendered manifests" || exit 0
          git push