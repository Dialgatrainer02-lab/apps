name: Render manifests

permissions:
  contents: write
  pull-requests: write

on:
  push:
    paths:
      - management/**
      - management/environments/**
      - apps/**
      - apps/environments/**
      - infra/**
      - infra/environments/**
      - .github/**

jobs:
  open-render-pr:
    runs-on: ubuntu-latest
    outputs:
      branch: render-manifest-pr

    steps:
      - uses: actions/checkout@v4

      - name: Create initial commit
        run: |
          git config user.name "gitops-bot"
          git config user.email "gitops-bot@example.com"
          git commit --allow-empty -m "chore(render): initialize render PR"

      - name: Open render PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: render-manifest-pr
          title: "chore(render): rendered manifests"
          body: |
            Automated render PR.

            Subsequent commits are added by matrix jobs.
          delete-branch: true


  render-apps:
    runs-on: ubuntu-latest
    needs: open-render-pr

    strategy:
      matrix:
        app:
          - media-stack
          - home-assistant

    steps:
      - uses: actions/checkout@v4
        with:
          ref: render-manifest-pr

      - uses: azure/setup-helm@v4

      - name: Add helm repos
        run: |
          set -euo pipefail
          for lock in $(find apps/ -name Chart.lock); do
            awk '/repository:/ {print $2}' "$lock" | sort -u | while read -r repo; do
              name=$(echo "$repo" | sed 's|https\?://||; s|/|-|g')
              helm repo add "$name" "$repo" || true
            done
          done
          helm repo update

      - name: Build deps
        run: |
          helm dependency build apps/${{ matrix.app }}

      - name: Render app
        run: |
          APP="${{ matrix.app }}"
          mkdir -p apps/rendered/prod/"$APP"

          helm template "$APP" apps/"$APP" -n "$APP" \
            | tee apps/rendered/prod/"$APP"/"$APP".yaml

      - name: Commit app render
        run: |
          git config user.name "gitops-bot"
          git config user.email "gitops-bot@example.com"

          git add apps/rendered/prod/
          git commit -m "chore(render): render app ${{ matrix.app }}" || exit 0

          git pull --rebase origin render-manifest-pr
          git push origin HEAD:render-manifest-pr

  render-infra:
    runs-on: ubuntu-latest
    needs: open-render-pr

    strategy:
      matrix:
        infra:
          - cert-manager
          - reloader

    steps:
      - uses: actions/checkout@v4
        with:
          ref: render-manifest-pr

      - uses: azure/setup-helm@v4

      - name: Add helm repos
        run: |
          set -euo pipefail
          for lock in $(find infra/ -name Chart.lock); do
            awk '/repository:/ {print $2}' "$lock" | sort -u | while read -r repo; do
              name=$(echo "$repo" | sed 's|https\?://||; s|/|-|g')
              helm repo add "$name" "$repo" || true
            done
          done
          helm repo update

      - name: Build deps
        run: |
          helm dependency build infra/${{ matrix.infra }}

      - name: Render infra
        run: |
          INFRA="${{ matrix.infra }}"
          mkdir -p infra/rendered/prod/"$INFRA"

          helm template "$INFRA" infra/"$INFRA" -n "$INFRA" \
            | tee infra/rendered/prod/"$INFRA"/"$INFRA".yaml

      - name: Commit infra render
        run: |
          git config user.name "gitops-bot"
          git config user.email "gitops-bot@example.com"

          git fetch
          git add infra/rendered/prod/
          git commit -m "chore(render): render infra ${{ matrix.infra }}" || exit 0

          git pull --rebase origin render-manifest-pr
          git push origin HEAD:render-manifest-pr
